---
  kind: "Template"
  apiVersion: "v1"
  metadata: 
    name: "workshop-example"
    annotations: 
      description: "An example PrestaShop application"
      tags: "quickstart,jboss"
      iconClass: "icon-jboss"
  labels: 
    template: "workshop-example"
  objects:
    - 
      kind: "Service"
      apiVersion: "v1"
      metadata: 
        name: "${NAME}"
        annotations: 
          description: "Exposes and load balances the application pods"
      spec: 
        ports:
          - name: 8080-tcp
            port: 8080
            protocol: TCP
            targetPort: 8080
          - name: 8443-tcp
            port: 8443
            protocol: TCP
            targetPort: 8443
        selector: 
          name: "${NAME}"
    - 
      kind: "Route"
      apiVersion: "v1"
      metadata: 
        name: "${NAME}"
      spec: 
        host: "${APPLICATION_DOMAIN}"
        port:
          targetPort: "8080"
        to: 
          kind: "Service"
          name: "${NAME}"
    - 
      kind: "ImageStream"
      apiVersion: "v1"
      metadata: 
        name: "${NAME}"
        annotations: 
          description: "Keeps track of changes in the application image"
    - 
      kind: "BuildConfig"
      apiVersion: "v1"
      metadata: 
        name: "${NAME}"
        annotations: 
          description: "Defines how to build the application"
      spec: 
        source: 
          type: "Git"
          git: 
            uri: "${SOURCE_REPOSITORY_URL}"
            ref: "${SOURCE_REPOSITORY_REF}"
          contextDir: "${CONTEXT_DIR}"
        strategy: 
          type: "Source"
          sourceStrategy: 
            from: 
              kind: "ImageStreamTag"
              namespace: "${NAMESPACE}"
              name: "jboss-webserver30-tomcat7-openshift:latest"
        output: 
          to: 
            kind: "ImageStreamTag"
            name: "${NAME}:latest"
        triggers: 
          - 
            type: "ImageChange"
          - 
            type: "ConfigChange"
          - 
            type: "GitHub"
            github: 
              secret: "${GITHUB_WEBHOOK_SECRET}"
    - 
      kind: "DeploymentConfig"
      apiVersion: "v1"
      metadata: 
        name: "${NAME}"
        annotations: 
          description: "Defines how to deploy the application server"
      spec:  
        strategy: 
          type: "Rolling"
          recreateParams: 
            pre: 
              failurePolicy: "Retry"
              execNewPod: 
                command: 
                  - "./migrate-database.sh"
                containerName: "workshop-example"
        triggers: 
          - 
            type: "ImageChange"
            imageChangeParams: 
              automatic: true
              containerNames: 
                - "workshop-example"
              from: 
                kind: "ImageStreamTag"
                name: "${NAME}:latest"
          - 
            type: "ConfigChange"
        replicas: 1
        selector: 
          name: "${NAME}"
        template:
          metadata:
            name: "${NAME}"
            labels: 
              name: "${NAME}"
          spec:
            containers:
            - 
              name: workshop-example
              image: library/workshop-example:latest
              ports:
              - containerPort: 8080
                protocol: TCP
              - containerPort: 8443
                protocol: TCP
  parameters: 
    - 
      name: "NAME"
      displayName: "Name"
      description: "The name assigned to all of the frontend objects defined in this template."
      required: true
      value: "workshop-example"
    - 
      name: "NAMESPACE"
      displayName: "Namespace"
      description: "The OpenShift Namespace where the ImageStream resides."
      value: "openshift"
    - 
      name: "SOURCE_REPOSITORY_URL"
      displayName: "Git Repository URL"
      description: "The URL of the repository with your application source code."
      value: "https://github.com/bcalomfirescu/workshop-example.git"
    - 
      name: "SOURCE_REPOSITORY_REF"
      displayName: "Git Reference"
      description: "Set this to a branch name, tag or other ref of your repository if you are not using the default branch."
    - 
      name: "CONTEXT_DIR"
      displayName: "Context Directory"
      description: "Set this to the relative path to your project if it is not in the root of your repository."
    - 
      name: "APPLICATION_DOMAIN"
      displayName: "Application Hostname"
      description: "The exposed hostname that will route to the PrestaShop service, if left blank a value will be defaulted."
      value: ""
    - 
      name: "GITHUB_WEBHOOK_SECRET"
      displayName: "GitHub Webhook Secret"
      description: "A secret string used to configure the GitHub webhook."
      generate: "expression"
      from: "[a-zA-Z0-9]{40}"
